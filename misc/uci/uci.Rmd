---
title: "UCI limitations"
author: "Brew, Chaccour, Garc√≠a-Basteiro, others?"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: "show"
---


## Read first: Implicit non-exclusivity agreement

- I (Joe) am working right now only under conditions of non-exclusivity.
- This means that if a collaborator (you) is working with me, (s)he understands that I may publish, share, or disseminate any ideas we generate together to whomever I deem suitable
- The condition goes both ways: the collaborator (you) also can share anything I do publicly, or with whomever you deem suitable
- The reason for this non-exclusivity pact is principle: the COVID-19 crisis requires extremely fast action, and any delays in publication or dissemination for the purposes of getting an "exclusive" publication, authorship, ownership, recognition, etc. is unacceptable
- If you don't like non-exclusivity (that is, you want me to "keep secret" any ideas we generate or work on together), that's fine. But find somebody else to work on.
- Just to be clear: If you are working with me, this means all of our code / data is public and can be shared by any of the collaborators (you and me) with anybody else.

## Question: How soon until Spain runs out of UCI beds?

## Methods

We define some parameters at the state level, generate a simple log-linear predictive model for daily UCI admissions weighted by days ago, and compare the capacity "ceiling" with prediction

## Code 


```{r setup, include=FALSE, echo = FALSE}
# Basic knitr options
library(knitr)
opts_chunk$set(comment = NA, 
               # echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
               # fig.width = 8.64,
               # fig.height = 4.86,
               fig.path = 'figures/')
```

```{r}
## Load libraries
library(covid19) #devtools::install_github('databrew/covid19')
library(ggplot2)
library(lubridate)
library(dplyr)
library(ggplot2)
library(sp)
library(raster)
library(viridis)
library(ggthemes)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
```


```{r}
# Define parameters
# Basing off: https://www.niusdiario.es/multimedia/nius-te-explica/colpaso-sistema-sanitario-espana-uci-unidad-cuidados-intensivos-hospitales-coronavirus_18_2914020237.html
p <- list(
  beds_public = 3508,
  beds_private = 896,
  normal_occupancy = 60,
  normal_occupancy_public = 60,
  normal_occupancy_private = 44,
  need_hospitalization = 15, # percent which requires hospitalization
  need_uci = 5, # percent which requires uci
  beds = 4404,
  average_days_in_uci = 3 # total rough estimate
)
options(scipen = '999')


make_prediction <- function(data,
                            n_start = 5,
                            cumulative = FALSE,
                            time_ahead = 7,
                            var = 'uci'){
                            
  sub_data <- data
  # Get the var
  the_var <- paste0(var, ifelse(cumulative, '', '_non_cum'))
  sub_data$var <- as.numeric(unlist(sub_data[,the_var]))
  # narrow down
  sub_data <- sub_data %>%
    dplyr::select(date, var)

  pd <- sub_data %>%
        filter(!is.na(var)) %>%
      mutate(start_date = min(date[var >= n_start])) %>%
      mutate(days_since = date - start_date) %>%
      filter(days_since >= 0) %>%
      mutate(days_since = as.numeric(days_since)) %>%
      mutate(the_weight = 1/(1 + (as.numeric(max(date) - date))))
  fit <- lm(log(var) ~ days_since,
              weights = the_weight,
              data = pd) 

    
    # Predict days ahead
    day0 <- pd$date[pd$days_since == 0]
    fake <- tibble(days_since = seq(0, max(pd$days_since) + time_ahead, by = 1))
    fake <- fake %>%mutate(date = seq(day0, day0+max(fake$days_since), by = 1))
    fake <- left_join(fake, pd %>% dplyr::select(days_since, var, date))
    fake$predicted <- exp(predict(fit, newdata = fake))
    # fake$predictedlo <- predict(fitlo, newdata = fake)
    ci <- exp(predict(fit, newdata = fake, interval = 'prediction'))
    # cilo <- predict(fitlo, newdata = fake, interval = 'prediction')

    fake$lwr <- ci[,'lwr']
    fake$upr <- ci[,'upr']
    # fake$lwrlo <- ci[,'lwr']
    # fake$uprlo <- ci[,'upr']
    # Doubling time
    dt <- log(2)/fit$coef[2]
    fake %>% mutate(doubling_time = dt)
}

plot_prediction <- function(data, ylog = F,
                            ci = FALSE){
  long <- data %>%
    tidyr::gather(key, value, var:predicted) %>%
    mutate(key = ifelse(key == 'var', 'Observed', key)) %>%
    mutate(key = Hmisc::capitalize(key))
  g <- ggplot()
  if(ci){
    g <- g +
      geom_ribbon(data = data %>% filter(date > max(long$date[!is.na(long$value) & long$key == 'Observed'])),
                aes(x = date,
                    ymax = upr,
                    ymin = lwr),
                alpha =0.6,
                fill = 'darkorange')
  }
  g <- g +
    geom_line(data = long,
              aes(x = date,
                  y = value,
                  group = key,
                  lty = key)) +
    geom_bar(data = long %>% filter(key == 'Observed'),
             stat = 'identity',
             alpha = 0.6,
               aes(x = date,
                   y = value)) +
    theme_simple() +
    theme(legend.position = 'right',
          legend.title = element_blank()) 
  if(ylog){
    g <- g + scale_y_log10()
  }
  return(g)
}


spain_data <- 
  esp_df %>% group_by(date) %>%
                               summarise_at(.vars = vars(uci, deaths, confirmed_cases,
                                            uci_non_cum,
                                            deaths_non_cum,
                                            confirmed_cases_non_cum),
                                            .fun = function(x){sum(x, na.rm = TRUE)})

pd <- make_prediction(data = spain_data,
                      n_start = 20,
                      cumulative = FALSE,
                      time_ahead = 5,
                      var = 'uci')
# Get the number of daily admissions to "spillover" for the number of days they need to be in UCI
# this function not estimating confidence bounds at this point
spill_over <- function(data,
                       days = p$average_days_in_uci){
  out <- data
  out$predicted_spilled_over <- out$var_spilled_over <- NA
  for(i in 1:nrow(out)){
    # Get the sub data for up to days days before
    sub_data <- out %>%
      filter(date >= out$date[i] -( days-1),
             date <= out$date[i])
    # Get the sum of ingresado people during that window
    sum_ingresado <- sum(sub_data$var, na.rm = TRUE)
    # Get the predicted sum too
    sum_predicted <- mean(sum(sub_data$predicted), na.rm = TRUE) * days
    # pop back into dataframe
    out$predicted_spilled_over[i] <- sum_predicted
    out$var_spilled_over[i] <- sum_ingresado
  }
  return(out)
}
pd <- pd %>% spill_over(days = p$average_days_in_uci)
```

```{r}
already_occupied <- (p$normal_occupancy/100) * p$beds
total_beds <- p$beds

# Shape data for plotting
plot_data <- pd %>%
  dplyr::select(date, var, predicted, predicted_spilled_over) %>%
  mutate(already_occupied = already_occupied) %>%
  tidyr::gather(key, value, var:already_occupied) %>%
  mutate(key = ifelse(key == 'already_occupied',
                      'UCI beds occupied (normal)',
                      ifelse(key == 'predicted_spilled_over',
                             'Predicted COVID-19 UCI beds',
                             key)))

ggplot() +
  geom_bar(data = plot_data %>%
             filter(key %in% c('UCI beds occupied (normal)',
                               'Predicted COVID-19 UCI beds')),
           aes(x = date,
               y = value,
               fill = key),
           stat = 'identity',
           alpha = 0.7) +
  # scale_y_log10() +
  geom_hline(yintercept = total_beds,
             lty = 2) +
  geom_text(data = tibble(x = min(plot_data$date) +2,
                          y = total_beds + 300,
                          label = 'Total UCI beds'),
            aes(x = x,
                y = y,
                label = label)) +
  theme_simple() +
  theme(legend.position = 'top') +
  scale_fill_manual(name = '',
                     values = rev(c('black', 'red'))) +
  labs(x = 'Date',
       y = 'Value',
       title = 'UCI bed capacity, Spain',
       subtitle = paste0('Assumes an average of ', p$average_days_in_uci, ' days in UCI.\nBased on simple log-linear growth model in daily UCI admissions',
                         caption = 'Code at github.com/databrew/covid19'))



```